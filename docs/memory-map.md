# GBA メモリマップとI/Oレジスタ

## メモリマップ全体図

| アドレス範囲 | サイズ | バス幅 | 説明 | 用途 |
|---|---|---|---|---|
| 0x00000000 - 0x00003FFF | 16 KB | 32bit | BIOS ROM | システムROM、起動処理 |
| 0x02000000 - 0x0203FFFF | 256 KB | 16bit | EWRAM | Thumb命令、データ格納 |
| 0x03000000 - 0x03007FFF | 32 KB | 32bit | IWRAM | ARM命令格納（高速） |
| 0x04000000 - 0x040003FF | 1 KB | - | I/O Registers | ハードウェア制御 |
| 0x05000000 - 0x050003FF | 1 KB | 16bit | Palette RAM | カラーパレット |
| 0x06000000 - 0x06017FFF | 96 KB | 16bit | VRAM | グラフィックスデータ |
| 0x07000000 - 0x070003FF | 1 KB | 32bit | OAM | スプライト属性 |
| 0x08000000 - 0x???????? | 最大32MB | 16bit | Game Pak ROM | ゲームプログラム |
| 0x0E000000 - 0x???????? | 可変 | 8bit | Game Pak SRAM | セーブデータ |

## メモリアクセス速度

各メモリ領域のアクセス速度は異なります：

- **IWRAM**: 最速（1サイクル）
- **VRAM**: 1-2サイクル
- **EWRAM**: 3サイクル
- **Game Pak ROM**: 3-8サイクル（ウェイトステート設定による）

## 主要I/Oレジスタ

### ディスプレイ制御

| アドレス | レジスタ名 | サイズ | 説明 |
|---|---|---|---|
| 0x04000000 | DISPCNT | 2byte | ディスプレイ制御 |
| 0x04000004 | DISPSTAT | 2byte | ディスプレイステータス |
| 0x04000006 | VCOUNT | 2byte | 垂直カウンタ |

#### DISPCNT (0x04000000) - ディスプレイ制御レジスタ

```
Bit   説明
0-2   BGモード (0-5)
3     CGB モード (0=GBA, 1=CGB)
4     ディスプレイフレーム選択 (0-1)
5     H-Blank時のOAMアクセス許可
6     オブジェクトキャラクタVRAMマッピング (0=2次元, 1=1次元)
7     強制ブランク
8     BG0表示 (0=Off, 1=On)
9     BG1表示 (0=Off, 1=On)
10    BG2表示 (0=Off, 1=On)
11    BG3表示 (0=Off, 1=On)
12    OBJ表示 (0=Off, 1=On)
13    Window 0表示 (0=Off, 1=On)
14    Window 1表示 (0=Off, 1=On)
15    OBJ Window表示 (0=Off, 1=On)
```

### 背景制御

| アドレス | レジスタ名 | サイズ | 説明 |
|---|---|---|---|
| 0x04000008 | BG0CNT | 2byte | BG0制御 |
| 0x0400000A | BG1CNT | 2byte | BG1制御 |
| 0x0400000C | BG2CNT | 2byte | BG2制御 |
| 0x0400000E | BG3CNT | 2byte | BG3制御 |
| 0x04000010 | BG0HOFS | 2byte | BG0 X方向スクロール |
| 0x04000012 | BG0VOFS | 2byte | BG0 Y方向スクロール |

### DMA転送制御

| アドレス | レジスタ名 | サイズ | 説明 |
|---|---|---|---|
| 0x040000B0 | DMA0SAD | 4byte | DMA0 転送元アドレス |
| 0x040000B4 | DMA0DAD | 4byte | DMA0 転送先アドレス |
| 0x040000B8 | DMA0CNT_L | 2byte | DMA0 ワード数 |
| 0x040000BA | DMA0CNT_H | 2byte | DMA0 制御 |

### タイマー制御

| アドレス | レジスタ名 | サイズ | 説明 |
|---|---|---|---|
| 0x04000100 | TM0CNT_L | 2byte | Timer 0 カウンタ/リロード |
| 0x04000102 | TM0CNT_H | 2byte | Timer 0 制御 |

### 割り込み制御

| アドレス | レジスタ名 | サイズ | 説明 |
|---|---|---|---|
| 0x04000200 | IE | 2byte | 割り込み許可 |
| 0x04000202 | IF | 2byte | 割り込みフラグ |
| 0x04000204 | WAITCNT | 2byte | ウェイトステート制御 |
| 0x04000208 | IME | 2byte | 割り込みマスター制御 |

### キー入力

| アドレス | レジスタ名 | サイズ | 説明 |
|---|---|---|---|
| 0x04000130 | KEYINPUT | 2byte | キー状態（0=押下、1=未押下） |
| 0x04000132 | KEYCNT | 2byte | キー割り込み制御 |

#### KEYINPUT (0x04000130) - キー入力レジスタ

```
Bit   ボタン
0     A
1     B
2     Select
3     Start
4     Right
5     Left
6     Up
7     Down
8     R
9     L
```

注意: 0=押下、1=未押下（負論理）

## VRAMの使用方法

### キャラクタモード（Mode 0-2）

- **0x06000000 - 0x0600FFFF**: BGキャラクタデータ（64KB）
- **0x06010000 - 0x06017FFF**: OBJキャラクタデータ（32KB）

### ビットマップモード（Mode 3-5）

- **Mode 3**: 0x06000000 - フルサイズフレーム（75KB使用）
- **Mode 4**: 0x06000000 - フレーム0、0x0600A000 - フレーム1
- **Mode 5**: 0x06000000 - フレーム0、0x0600A000 - フレーム1

## パレットRAM構成

### BGパレット
- **アドレス**: 0x05000000 - 0x050001FF (512バイト)
- **構成**: 16パレット × 16色

### OBJパレット
- **アドレス**: 0x05000200 - 0x050003FF (512バイト)
- **構成**: 16パレット × 16色

### カラーフォーマット
```
Bit     0  1  2  3  4  5  6  7  8  9 10 11 12 13 14 15
Data    R  R  R  R  R  G  G  G  G  G  B  B  B  B  B  -
```
5bit RGB（各色0-31の範囲）

## OAM構成

OAMは128個のオブジェクト（スプライト）の属性を保持します。
各オブジェクトは8バイト（4個の16bitワード）を使用します。

### オブジェクト属性

```
Attribute 0 (0x07000000 + n*8)
Bit 0-7   : Y座標
Bit 8-9   : 回転/拡大モード
Bit 10-11 : オブジェクトモード (通常/半透明/ウィンドウ)
Bit 12    : モザイク
Bit 13    : カラーモード (0=16色, 1=256色)
Bit 14-15 : オブジェクト形状

Attribute 1 (0x07000000 + n*8 + 2)
Bit 0-8   : X座標
Bit 9-13  : 回転/拡大パラメータ or H/Vフリップ
Bit 14-15 : オブジェクトサイズ

Attribute 2 (0x07000000 + n*8 + 4)
Bit 0-9   : キャラクタ名
Bit 10-11 : 優先度
Bit 12-15 : パレット番号
```

## 実装時の注意事項

### メモリアライメント
- 32bitアクセス: 4バイト境界にアライン
- 16bitアクセス: 2バイト境界にアライン
- 8bitアクセス: アライメント不要

### ウェイトステート
Game Pak ROMへのアクセスはウェイトステートを考慮する必要があります。
WAITCNTレジスタ（0x04000204）で設定可能です。

### DMAの活用
大量のデータ転送（VRAM更新など）にはDMAを使用すると高速化できます。

## 参考資料

- [GBA Memory Map - gbadoc](https://gbadev.net/gbadoc/memory.html)
- [GBATEK GBA Memory Map](http://problemkaputt.de/gbatek-gba-memory-map.htm)
- [Tonc: GBA Hardware](https://www.coranac.com/tonc/text/hardware.htm)
