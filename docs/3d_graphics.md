# GBA 3D/疑似3Dグラフィック実装ガイド

## 概要
GameBoy Advanceには専用の3Dハードウェアは搭載されていませんが、アフィン変換とスプライトスケーリングを使用して疑似3D効果を実現できます。

## Mode 7とアフィン変換

### 基本原理
Mode 7は、SNESで導入された透視変換効果で、GBAでも同様の技術が使用できます。
回転・スケーリングに加えて、透視を追加して3D効果を生み出します。

### 4段階の変換プロセス
1. **事前平行移動**: カメラ位置 **a** = (a_x, a_z) で視点を原点に移動
2. **回転**: ヨー角 α を適用
3. **透視除算**: ズーム係数 λ = a_y / h で全体をスケーリング
4. **事後平行移動**: 画面位置への修正オフセット

### アフィン行列の計算
変換行列 **P** は以下の通り：
```
P = S(λ) · R(α) = [λ·cos(α)  -λ·sin(α)]
                   [λ·sin(α)   λ·cos(α)]
```

## 固定小数点演算

GBAにはFPUが搭載されていないため、固定小数点演算が必須です。

### 実装方式

**タイプC（スムーズ - 推奨）**
- スケーリング×回転を先に計算し、その後で.8に下げてからオフセット乗算
- オフセット計算時にアフィン要素を先にシフトダウン
```go
// 最適な実装
lxr = 120 * (lcf >> 4)  // 推奨

// 非推奨
// lxr = (120 * lcf) >> 4
```

### 精度の選択
- λ（ズーム係数）には.12固定小数点を使用
- 最終的な画面座標は.8で十分
- オーバーフロー対策として.12が.16より推奨

## スプライトを使った3D表現

### スケーリングと配置
- スプライトのスケーリング機能を使用して遠近感を表現
- GBAは32個のスプライトでアフィン変換をサポート
- Z座標に応じてスプライトのサイズを動的に変更

### サブピクセル移動
- スムーズな動きのために、サブピクセル単位での位置管理
- 固定小数点演算を使用して精密な移動を実現

### 深度管理
- Z座標（深度）に基づいてスプライトの優先度を設定
- 遠くのオブジェクトは小さく、近くのオブジェクトは大きく表示

## 実装上の考慮事項

### パフォーマンス
- HBlankハンドラ内での実行が必要な場合あり（スキャンラインごとの変更）
- 32ビット演算で十分（64ビット不要）
- 演算順序が最終的な品質に大きく影響

### メモリ管理
- VRAMの効率的な使用
- スプライト数の制限（通常は128個、アフィン変換可能なのは32個）

## バスケフリースローゲームへの適用

### ボールの3D表現
- スプライトスケーリングで遠近感を表現
- Z座標に基づいてボールサイズを変更
- 放物線軌道の計算に固定小数点演算を使用

### カメラとゴール
- ゴールは画面上部に固定
- カメラは選手の後方から見た視点
- 深度に応じてゴールのサイズも調整可能
